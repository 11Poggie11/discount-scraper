<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swipe Deals</title>
    <link rel="stylesheet" href="/static/style.css"> <!-- Link to external CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet"> <!-- Google Fonts -->
</head>
<body>
    <h1>Swipe Deals</h1>

    <!-- App Container -->
    <div id="app"></div>

    <script>
        const app = document.getElementById('app');
        
        let currentIndex = 0; // Tracks current deal
        let deals = [];

        // Fetch deals from the backend
        async function fetchDeals() {
            const response = await fetch('/api/deals');
            
            // Parse response JSON
            deals = await response.json();
            
            // Reset current index and render the first card
            currentIndex = 0; 
            renderCard();
        }

        function renderCard() {
            if (currentIndex >= deals.length) {
                app.innerHTML = '<h2>No more deals!</h2>';
                return;
            }

            const deal = deals[currentIndex];

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img src="${deal.image_url}" alt="${deal.product_name}">
                <h3>${deal.product_name}</h3>
                <p>Price: €${deal.price} ${deal.old_price ? `(was €${deal.old_price})` : ''}</p>
                <p>Discount Percentage : ${deal.discount_percentage}%</p>
                <a href="${deal.url}" target="_blank">View Deal</a>
            `;

            app.innerHTML = '';
            app.appendChild(card);

            console.log('Card rendered, adding swipe functionality');
            addSwipeFunctionality(card);
        }

        function addSwipeFunctionality(card) {
            let startX;

            console.log('Swipe functionality added to card');

            card.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                console.log('Touchstart detected:', startX);
            });

            card.addEventListener('touchmove', (e) => {
                const moveX = e.touches[0].clientX - startX;
                console.log('Touchmove detected:', moveX);

                card.style.transform = `translateX(${moveX}px)`;
                card.style.opacity = `${1 - Math.abs(moveX) / window.innerWidth}`;
            });

            card.addEventListener('touchend', (e) => {
                const moveX = e.changedTouches[0].clientX - startX;
                console.log('Touchend detected:', e.changedTouches[0].clientX);
                console.log('MoveX:', moveX);

                if (moveX > 50 || moveX < -50) { 
                    console.log('Swipe detected, moving to next card');
                    currentIndex++;
                    renderCard();
                } else { 
                    console.log('Swipe not detected, resetting styles');
                    card.style.transform = 'translateX(0)';
                    card.style.opacity = '1';
                }
            });

            // Temporary click listener for debugging
            card.addEventListener('click', () => {
                console.log('Card clicked!');
            });
        }

        // Check for touch event support
        if (!('ontouchstart' in window)) {
            console.warn('Touch events not supported on this device/browser');
        }

        // Fetch and render deals on page load
        fetchDeals();
    </script>
</body>
</html>
