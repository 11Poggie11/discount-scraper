<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swipe Deals</title>
    <link rel="stylesheet" href="/static/style.css"> <!-- Link to external CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet"> <!-- Google Fonts -->
</head>
<body>
    <h1>Swipe Deals</h1>

    <!-- App Container -->
    <div id="app"></div>

    <script>
        const app = document.getElementById('app');
        
        let currentIndex = 0; // Tracks current deal
        let deals = [];

        // Fetch deals from the backend
        async function fetchDeals() {
            const response = await fetch('/api/deals');
            
            // Parse response JSON
            deals = await response.json();
            
            // Reset current index and render the first card
            currentIndex = 0; 
            renderCard();
        }

        function renderCard() {
            if (currentIndex >= deals.length) {
                app.innerHTML = '<h2>No more deals!</h2>';
                return;
            }

            const deal = deals[currentIndex];

            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.dealId = deal.id;
            card.innerHTML = `
                <img src="${deal.image_url}" alt="${deal.product_name}">
                <h3>${deal.product_name}</h3>
                <p>Price: €${deal.price} ${deal.old_price ? `(was €${deal.old_price})` : ''}</p>
                <p>Discount Percentage : ${deal.discount_percentage}%</p>
                <a href="${deal.url}" target="_blank">View Deal</a>
            `;

            app.innerHTML = '';
            app.appendChild(card);

            addSwipeFunctionality(card);
        }

        function addSwipeFunctionality(card) {
            let startX;

            card.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            });

            card.addEventListener('touchmove', (e) => {
                const moveX = e.touches[0].clientX - startX;

                card.style.transform = `translateX(${moveX}px)`;
                card.style.opacity = `${1 - Math.abs(moveX) / window.innerWidth}`;
            });

            card.addEventListener('touchend', (e) => {
                const moveX = e.changedTouches[0].clientX - startX;

                if (moveX > 50 || moveX < -50) { 
                    markDealAsViewed(card.dataset.dealId); // Mark as viewed
                    currentIndex++;
                    renderCard();
                } else { 
                    card.style.transform = 'translateX(0)';
                    card.style.opacity = '1';
                }
            });
        }

        // Function to mark a deal as viewed
        async function markDealAsViewed(dealId) {
            try {
                const response = await fetch('/api/mark_viewed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deal_id: dealId }) // Send deal ID as JSON payload
                });

                const result = await response.json();
                if (!response.ok) {
                    console.error(result.error || 'Failed to mark deal as viewed');
                } else {
                    console.log(result.message); // Log success message
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Fetch and render deals on page load
        fetchDeals();
    </script>
</body>
</html>
